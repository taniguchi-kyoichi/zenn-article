---
title: "Isarã¨Riverpodã§ãƒ­ãƒ¼ã‚«ãƒ«DBç®¡ç†"
emoji: "ğŸ“±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Isar", "Riverpod", "Flutter", "Dart"]
published: true
---

ã“ã‚“ã«ã¡ã¯ã€Flutterã§å€‹äººã‚¢ãƒ—ãƒªé–‹ç™ºã‚’ã—ã¦ã„ã‚‹å¤§å­¦ç”Ÿã§ã™ã€‚æ•°é€±é–“ã»ã©å‰ã«æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã—ãŸã€‚ã©ã‚“ãªã‚¢ãƒ—ãƒªã‹ã¨ã„ã†ã¨ã€
#### è‡ªå·±ç®¡ç†ãŒã§ããªãã¦ã€ã ã‚‰ã‘ã¦ã—ã¾ã†ã€‚ã€‚ã€‚
ã¨ã„ã†äººã®ãŸã‚ã®ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¿’æ…£åŒ–ã‚¢ãƒ—ãƒªã§ã™ï¼
- ##### ã€Œå‹‰å¼·30åˆ†50å††ã€ã®ã‚ˆã†ã«ã‚„ã‚‹ã¹ãã“ã¨ã«å ±é…¬ã‚’è¨­å®šã—ã¦ã€è‡ªå·±ç®¡ç†ã‚’ã™ã‚‹
- ##### ã€Œæ—…è¡Œ40,000å††ã€ã®ã‚ˆã†ã«ã€"ã”ã»ã†ã³"ã‚’è¨­å®šã—ã¦ãŠé‡‘ãŒæºœã¾ã£ãŸã‚‰æ›é‡‘ã§ãã‚‹
ã¨ã„ã†ã‚³ã‚¢æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã¤ã¾ã‚Šãƒ»ãƒ»ãƒ»
### RPGã‚²ãƒ¼ãƒ ã®ãƒ¬ãƒ™ãƒ«ä¸Šã’ã‚’ã™ã‚‹ã‚ˆã†ãªç¿’æ…£åŒ–
ã‚’å®Ÿç¾ã§ãã¾ã™ï¼ï¼ãœã²ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ï¼
https://apps.apple.com/jp/app/%E3%81%94%E3%81%BB%E3%81%86%E3%81%B3%E7%BF%92%E6%85%A3-%E3%82%B2%E3%83%BC%E3%83%A0%E6%84%9F%E8%A6%9A%E3%81%A7%E8%87%AA%E5%B7%B1%E7%AE%A1%E7%90%86/id1671700938

ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«DBã«æ¬¡ã€…å€¤ã‚’ä¿å­˜ãƒ»ç·¨é›†ã—ã¦ã„ãã‚ˆã†ãªæ©Ÿèƒ½ãŒå¿…è¦ã§ã—ãŸã€‚
ãã“ã§Isarã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã€ä½¿ã£ã¦ã¿ã‚‹ã¨çµæ§‹ä¾¿åˆ©ã§é«˜é€Ÿã§ã—ãŸã€‚
ã¾ãŸIsarã¯é–‹ç™ºã•ã‚Œã¦ã‹ã‚‰ãã“ã¾ã§æ™‚é–“ãŒçµŒã£ã¦ã„ãªã„ã®ã§ã€Webä¸Šã«ã‚ã¾ã‚Šè¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã‚ˆã£ã¦ã€ã“ã®è¨˜äº‹ã§ã¯Isarã®åŸºæœ¬ã¨å®Ÿéš›ã®é–‹ç™ºã§ã‚ã‚Šãã†ãªã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ã€Riverpodã¨ã®é€£æºã‚’è§£èª¬ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚


## [Isar Database](https://pub.dev/packages/isar "Isar")
[Isar](https://pub.dev/packages/isar "Isar")ã¯ãƒ­ãƒ¼ã‚«ãƒ«DBã‚’ç®¡ç†ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚[Hive](https://pub.dev/packages/hive "Hive")ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå…ˆã«ã‚ã‚Šã€ãã®å¾Œç¶™ã¨ãªã£ã¦ã„ã¾ã™ã€‚
Isarã¯ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®[sqflite](https://pub.dev/packages/sqflite "sqflite")ã¨ç•°ãªã‚Šã€ã‚­ãƒ¼ãƒãƒªãƒ¥ãƒ¼å½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹NoSQLã§ã™ã€‚Firebase Firestoreã¨åŒã˜ã‚ˆã†ãªå½¢å¼ã¨è¨€ãˆã¾ã™ã€‚
è‡ªåˆ†ã¯ã¾ã ä½¿ã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ãŒã‚ã‚‹ã‚‰ã—ã„ï¼
ã¾ãŸã€Isarã¯å„ªç§€ãªæ—¥æœ¬èªãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãŒã‚ã‚‹ã®ã§ã€ç›¸å½“å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„ã¨æ€ã„ã¾ã™ã€‚
https://isar.dev/ja/tutorials/quickstart.html

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚ã°ã€ä¸€é€šã‚Šã®å®Ÿè£…æ–¹æ³•ã¯ã‚ã‹ã‚Šã¾ã™ãŒã€ç°¡å˜ã«è¦ç´„ã—ã¾ã™ã€‚
Isarã¯ä»¥ä¸‹ã®æ‰‹é †ã§å®Ÿè£…ã§ãã¾ã™ã€‚
### ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
```shell
$ flutter pub add isar isar_flutter_libs
$ flutter pub add -d isar_generator build_runner
```

### ãƒ‡ãƒ¼ã‚¿ã®å®šç¾©
```dart
part 'email.g.dart';

@collection
class User {
  Id id = Isar.autoIncrement; // id = nullã§ã‚‚è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã¾ã™ã€‚

  String? name;

  int? age;
}
```
IDã¯è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã§ã¯ãªãã€è‡ªèº«ã§æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã€‚
Isarã®ã‚¯ãƒ©ã‚¹ã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨å‘¼ã°ã‚Œã‚‹ã€‚ï¼ˆFirestoreã¨åŒã˜ï¼‰
ã¾ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒå¯¾å¿œã—ã¦ã„ã‚‹ã€‚

- bool
- byte
- short
- int
- float
- double
- DateTime
- String
- List<bool>
- List<byte>
- List<short>
- List<int>
- List<float>
- List<double>
- List<DateTime>
- List<String>

ã¾ãŸã€ã“ã®ä»–ã«Enumã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ä½¿ã„å‹æ‰‹ãŒã„ã„ï¼



### ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
```shell
$ flutter pub run build_runner build
```
freezedã®ã‚ˆã†ã« `--delete-conflicting-outputs`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ãŸã»ã†ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚


### Isarã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å–å¾—, CRUD
```dart
// ä¿å­˜ã™ã‚‹ãƒ‘ã‚¹ã®æŒ‡å®šï¼ˆãƒ‘ã‚¹ã‚’æŒ‡å®šã—ãªãã¦ã‚‚è‰¯ã„ï¼‰
var path = '';
if (!kIsWeb) {
    final dir = await getApplicationSupportDirectory();
    path = dir.path;
}
isar = await Isar.open(
    [EmailSchema,],
    directory: path,
);

final newUser = User()..name = 'Jane Doe'..age = 36;

await isar.writeTxn(() async {
  await isar.users.put(newUser); // æŒ¿å…¥ã¨æ›´æ–°
});

final existingUser = await isar.users.get(newUser.id); // å–å¾—

await isar.writeTxn(() async {
  await isar.users.delete(existingUser.id!); // å‰Šé™¤
});
```

ã“ã®ã‚ˆã†ã«Isarã§ã¯ç›¸å½“å°‘ãªã„ã‚³ãƒ¼ãƒ‰ã§å®Ÿè£…ã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã“ã¾ã§ãŒIsarã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã§ã™ã€‚

## Riverpodã¨ä¸€ç·’ã«ä½¿ã†
Flutterã‚¢ãƒ—ãƒªã®è¨­è¨ˆã¨ã—ã¦ã‚ˆãç”¨ã„ã‚‰ã‚Œã¦ã„ã‚‹ã®ãŒriverpodã ã¨æ€ã„ã¾ã™ã€‚ãã“ã§ã€Isarã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’StateNotifierã§ãƒ©ãƒƒãƒ—ã—ã¦Providerã§ç›£è¦–ã™ã‚‹ã‚ˆã†ãªè¨­è¨ˆã‚’è€ƒãˆã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚ãŸã ã—ã€Isarã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨åŒã˜Emailã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¾ã™ã€‚

### Isarã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã«ã™ã‚‹
Isarã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯SharedPreferencesã®ã‚ˆã†ã«ï¼‘ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…±æœ‰ã—ã¦ãŠã‘ã°è‰¯ã„ã¨è€ƒãˆã¦ã€ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã§å®Ÿè£…ã—ã¾ã™ã€‚

```dart
class MyIsar {
  late Isar isar;

  static final MyIsar _instance = MyIsar._internal();

  factory MyIsar() {
    return _instance;
  }

  MyIsar._internal();

  Future<void> init() async {
    MyIsar._internal();

    var path = '';
    if (!kIsWeb) {
      final dir = await getApplicationSupportDirectory();
      path = dir.path;
    }
    isar = await Isar.open(
      [EmailSchema],
      directory: path,
    );
  }
}
```

### Isarã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆã‚’StateNotifierã§ãƒ©ãƒƒãƒ—ã—ã¦ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©
```dart
class EmailListState extends StateNotifier<List<Email>> {
  EmailListState(List<Email> emailList) : super([]);

  final Isar isar = MyIsar().instance.isar;

  Future<void> getAll() async {
    final list = isar.emails;
    final getList = await list.where().findAll();
    state = getList;
  }

  Future<void> add(Email item) async {
    final list = isar.emails;
    await isar.writeTxn(() async {
      await list.put(item);
    });
    await getAll();
  }

  Future<void> deleteAt(int id) async {
    final list = isar.emails;
    await isar.writeTxn(() async {
      await list.delete(id);
    });
    await getAll();
  }

  Future<void> deleteAll() async {
    final list = isar.emails;
    await isar.writeTxn(() async {
      await list.where().deleteAll();
    });
    await getAll();
  }
}

```

### Providerã‚’å®šç¾©
```dart
final emailListStateNotifierProvider =
StateNotifierProvider<EmailListState, List<Email>>(
      (ref) => EmailListState([]),
);
```

### mainé–¢æ•°å†…ã§Isarã‚’åˆæœŸåŒ–ã—ã¦ãŠã
```dart
void main() {
  WidgetsBinding widgetsBinding = WidgetsFlutterBinding.ensureInitialized();
  await MyIsar().init();

  runApp(const ProviderScope(
    child: MyApp(),
  ));
}
```

ä»¥ä¸Šã®æ–¹æ³•ã§Isarã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›£è¦–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚addãƒ¡ã‚½ãƒƒãƒ‰ãªã©ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ­ãƒ¼ã‚«ãƒ«DBãŒå¤‰æ›´ã•ã‚Œã€å¤‰æ›´ã•ã‚ŒãŸãƒ­ãƒ¼ã‚«ãƒ«DBã‚’å†å–å¾—ã—ã€è‡ªå‹•çš„ã«ProviderãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã„ã†è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚ã‚ˆã£ã¦UI - state - ãƒ­ãƒ¼ã‚«ãƒ«DB é–“ã«å˜æ–¹å‘ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãŒä¿ãŸã‚Œã‚‹ã¨ã„ã†ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚
